{% extends 'base.html.twig' %}

{% block title %}Page d'appel - {{ category|upper }}
{% endblock %}

{% block body %}
<link href="/css/attendance.css" rel="stylesheet"/>
<style>
    img {
        filter: grayscale(100%) brightness(50%); 
    }
</style>

<div class="col-lg-8 mx-auto p-5 py-md-5">
    <div class="mt-3 text-center">
        <h1 class="h1 mb-2 display-4">Page d'appel - {{ category|upper }}</h1>
    </div>

    <div class="row row-cols-2 row-cols-md-2 row-cols-lg-4 g-4 pt-5">
        {% for user in users %}
            <div class="col">
                <div class="img card-attendance-u zoom" data-user-id="{{ user.id }}">
                    <div class="abs present"><img src="/images/arthur-delacour.png" class="card-img-top" alt="..."></div>
                    <div class="card-body">
                        <h5 class="card-title text-center pt-1">{{ user.firstName }} {{ user.lastName }}</h5>
                    </div>        
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="g-4 pt-5 row">
        <div class="col text-end" style="text-align: start;">
            <a class="btn btn-success" id="finaliserAppel">Finaliser l'appel</a>
        </div>
        <div class="col">
            <a class="btn btn-danger" href="{{ path('app_attendance', {'category': category}) }}">Annuler l'appel</a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const abss = document.querySelectorAll('.abs');
        const presentUserIds = [];
        const absentUserIds = [];

        abss.forEach(abs => {
            presentUserIds.push(abs.closest('.img').getAttribute('data-user-id'));
            abs.addEventListener('click', function() {
                abs.classList.toggle('present');
                abs.classList.toggle('absent');

                // Get the user ID
                const userId = abs.closest('.img').getAttribute('data-user-id');

                if (abs.classList.contains('present')) {
                    presentUserIds.push(abs.closest('.img').getAttribute('data-user-id'));

                    const reasonSelector = document.getElementById('reasonSelector' + userId);
                    reasonSelector.remove();
                } else {
                    const index = presentUserIds.indexOf(abs.closest('.img').getAttribute('data-user-id'));
                    if (index !== -1) {
                        presentUserIds.splice(index, 1);
                    }
                }
                if (abs.classList.contains('absent')) {
                    const reasonSelectorDiv = document.createElement('div');
                    reasonSelectorDiv.classList.add('reason-selector');
                    reasonSelectorDiv.id = 'reasonSelector' + userId;
                    reasonSelectorDiv.innerHTML = `
                        <select class="form-select">
                            <option value="malade">Malade</option>
                            <option value="blesse">Blessé</option>
                            <option value="sport">Sport</option>
                        </select>
                    `;
                    abs.closest('.img').appendChild(reasonSelectorDiv);
                } else {
                    const index = absentUserIds.indexOf(abs.closest('.img').getAttribute('data-user-id'));
                    if (index !== -1) {
                        absentUserIds.splice(index, 1);
                    }
                }
            });
        });

        function finalizeAttendanceAndRedirect() {
            // Display a confirmation dialog
            const isConfirmed = confirm("Êtes-vous sûr de vouloir finaliser l'appel ?");

            if (isConfirmed) {
                // Continue with the attendance finalization process
                const updateMatchesPlayedURL = '{{ path('update_matches_played', {'category': category}) }}';
                const reasonSelectors = document.querySelectorAll('.reason-selector select');

                reasonSelectors.forEach((select) => {
                    const userId = select.closest('.img').getAttribute('data-user-id');
                    const reason = select.value;

                    const absElement = select.closest('.img').querySelector('.abs');

                    if (absElement.classList.contains('present')) {
                        presentUserIds.push({
                            userId: userId
                        });
                    }

                    if (absElement.classList.contains('absent')) {
                        absentUserIds.push({
                            userId: userId,
                            reason: reason
                        });
                    }
                });

                fetch(updateMatchesPlayedURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        presentUserIds: presentUserIds,
                        absentUserIds: absentUserIds,
                        category: '{{ category }}'
                    })
                }).then(response => {
                    if (response.ok) {
                        alert('Appel effectué avec succès!');
                        window.location.href = '{{ path('app_attendance') }}';
                    } else {
                        alert('Erreur, l\'appel n\'a pas pu être effectué !');
                    }
                });
            }
        }

        document.getElementById('finaliserAppel').addEventListener('click', finalizeAttendanceAndRedirect);
    });
</script>

{% endblock %}
